<!DOCTYPE html>
<html>
<body>
<pre><code id="log"></code></pre>
<style>
	body { background: lightgreen }
	pre { display: inline-grid }
</style>
<script>
function log(msg) {
	document.querySelector('#log').innerText += msg+'\n';
}

log('210702.2006');
log(navigator.userAgent);
log('Mode: '+(navigator.userAgent.match(/(steam|smart-tv)/i) ? 'TV' : 'tablet'));
var controllers = {};
var loop;
function connecthandler(e) {
	var gamepad = e.gamepad;
	var json = {
		id: gamepad.id,
		mapping: gamepad.mapping,
		axes: gamepad.axes,
		buttons: Object.keys(gamepad.buttons)
	};
	console.log('connecthandler', JSON.stringify(json, null, '\t'));
	log('gamepadconnected: '+gamepad.id);
	log('mapping: '+gamepad.mapping);
	controllers[gamepad.index] = gamepad;
	for (var i=0; i<gamepad.buttons.length; i++) {
		var e = document.createElement("code");
		e.id = 'button_'+i;
		e.innerHTML = 'Button '+i;
		document.querySelector('pre').appendChild(e);
	}
	for (i=0; i<gamepad.axes.length; i++) {
		var e = document.createElement("code");
		e.id = 'axis_'+i;
		e.innerHTML = 'Axis '+i;
		document.querySelector('pre').appendChild(e);
	}
	loop = window.requestAnimationFrame(updateStatus);
}
function disconnecthandler(e) {
	console.log('disconnecthandler', e);
	var gamepad = e.gamepad;
	log('gamepaddisconnected: '+gamepad.id);
	cancelAnimationFrame(loop);
	delete controllers[gamepad.index];
}
function updateStatus() {
	var mapb = [
		[ 'Y', 'B', 'A', 'X', 'LB', 'RB', 'LT', 'RT', 'select', 'start', 'LS', 'RS', 'GUIDE' ],
		[ 'A', 'B', 'X', 'Y', 'LB', 'RB', 'LT', 'RT', 'select', 'start', 'LS', 'RS', 'LKVU', 'LKVD', 'LKHL', 'LKHR', 'GUIDE' ]
	], mapa = [
		[ 'LSH', 'LSV', 'RSH', 'RSV', 'LKH', 'LKV' ],
		[ 'LSH', 'LSV', 'RSH', 'RSV' ]
	];
	scangamepads();
	for (j in controllers) {
		var controller = controllers[j];
		for (var i=0; i<controller.buttons.length; i++) {
			var b = document.querySelector('#button_'+i);
			var val = controller.buttons[i];
			var pressed = val == 1.0;
			var touched = false;
			if (typeof(val) == "object") {
				pressed = val.pressed;
				if ('touched' in val)
					touched = val.touched;
				val = val.value;
			}
			var pct = Math.round(val * 100) + "%";
			b.innerHTML = '('+mapb[0][i]+'/'+mapb[1][i]+') '+'Button '+i+': '+pct;
			if (pressed)
				b.innerHTML += ": pressed";
			if (touched)
				b.innerHTML += ": touched";
		}
		for (var i=0; i<controller.axes.length; i++) {
			var a = document.querySelector('#axis_'+i);
			a.innerHTML = '('+mapa[0][i]+'/'+mapa[1][i]+') '+'Axis '+i+': '+controller.axes[i];
		}
	}
	window.requestAnimationFrame(updateStatus);
}
function scangamepads() {
	var gamepads = navigator.getGamepads();
	for (var i = 0; i < gamepads.length; i++) {
		if (gamepads[i] && (gamepads[i].index in controllers))
			controllers[gamepads[i].index] = gamepads[i];
	}
}
if ('GamepadEvent' in window) {
	window.addEventListener("gamepadconnected", connecthandler);
	window.addEventListener("gamepaddisconnected", disconnecthandler);
}

</script>
</body>
</html>
